{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<section class="py-5">
  <div class="container">
    <div class="row g-4">
      <!-- Course Info -->
      <div class="col-lg-8">
        <h2 class="fw-bold">{{ course.title }}</h2>
        <div class="text-muted mb-3">{{ course.category }}</div>
        <p>{{ course.description }}</p>

        <!-- Progress Bar -->
        {% if enrollment %}
        <div class="progress my-3">
          <div class="progress-bar" role="progressbar"
               style="width: {{ enrollment.progress }}%;"
               aria-valuenow="{{ enrollment.progress|floatformat:0 }}"
               aria-valuemin="0" aria-valuemax="100">
            {{ enrollment.progress|floatformat:0 }}% Complete
          </div>
        </div>

        <!-- Next Lesson -->
        {% if next_lesson %}
        <div class="alert alert-info mt-3">
          <strong>Next Lesson:</strong> {{ next_lesson.title }}
          <a href="#collapse{{ next_lesson.id }}" class="btn btn-sm btn-primary ms-2">
            Resume
          </a>
        </div>
        {% endif %}
        {% endif %}

        <!-- Lessons Accordion -->
        <h4 class="fw-bold mt-4">Lessons</h4>
        <div class="accordion" id="lessonAccordion">
          {% for lesson in lessons %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading{{ lesson.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#collapse{{ lesson.id }}">
                  {{ lesson.title }}
                </button>
              </h2>
              <div id="collapse{{ lesson.id }}" class="accordion-collapse collapse" data-bs-parent="#lessonAccordion">
                <div class="accordion-body">
                  <p>{{ lesson.content }}</p>
                    {% if lesson.video_url %}
                      <div class="ratio ratio-16x9">
                        <iframe src="{{ lesson.embed_url }}" frameborder="0" allowfullscreen></iframe>
                      </div>
                    {% endif %}
                    {% if user.is_authenticated and enrollment %}
                    <form method="post" action="{% url 'courses:complete_lesson' lesson.id %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-success mt-2">Mark Complete</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">No lessons yet.</p>
          {% endfor %}
        </div>

        <!-- Reviews -->
        <h4 class="fw-bold mt-4">Latest Reviews</h4>
        {% for review in reviews|slice:":3" %}
          <div class="border rounded p-3 mb-2">
            <strong>{{ review.user.username }}</strong>
            <span class="text-warning">★ {{ review.rating }}</span>
            <p class="mb-0">{{ review.comment }}</p>
          </div>
        {% empty %}
          <p class="text-muted">No reviews yet.</p>
        {% endfor %}

        {% if reviews|length > 3 %}
          <a href="#allReviews" class="btn btn-link">See all reviews</a>
        {% endif %}

        <!-- All Reviews -->
        <div id="allReviews" class="mt-4">
          <h5 class="fw-bold">All Reviews</h5>
          {% for review in reviews %}
            <div class="border rounded p-3 mb-2">
              <strong>{{ review.user.username }}</strong>
              <span class="text-warning">★ {{ review.rating }}</span>
              <p class="mb-0">{{ review.comment }}</p>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        {% if enrollment %}
          <!-- Already enrolled -->
          <a href="{% url 'courses:my_courses' %}" class="btn btn-success w-100">
            Go to My Courses
          </a>
          {% if next_lesson %}
          <a href="#collapse{{ next_lesson.id }}" class="btn btn-outline-primary w-100 mt-2">
            Resume Course
          </a>
          {% endif %}
          <div class="p-4 bg-light rounded mt-3">
            <div class="fw-bold fs-4">₹{{ course.price }}</div>
            <p class="text-muted mb-0">You are already enrolled in this course.</p>
          </div>
        {% else %}
          <!-- Not enrolled -->
          <a href="{% url 'accounts:signup' %}" class="btn btn-primary w-100">
            Enroll Now
          </a>
          <a href="{% url 'checkout:mock_checkout' course.slug %}" class="btn btn-outline-primary w-100 mt-2">
            Buy Now
          </a>
          <div class="p-4 bg-light rounded mt-3">
            <div class="fw-bold fs-4">₹{{ course.price }}</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}